From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Ivan Pekov <ivan@mrivanplays.com>
Date: Wed, 26 Aug 2020 21:01:33 +0300
Subject: [PATCH] Load also the chunk that you're teleporting to

Fixes Tuinity-178

diff --git a/src/main/java/net/minecraft/server/WorldServer.java b/src/main/java/net/minecraft/server/WorldServer.java
index 86c8a815920125accfbca45639dc2d4db3ce0eaf..e97c6bd19c8c8a5f3726d453455667abb6958349 100644
--- a/src/main/java/net/minecraft/server/WorldServer.java
+++ b/src/main/java/net/minecraft/server/WorldServer.java
@@ -239,7 +239,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
         return true;
     }
 
-    public final void loadChunksForMoveAsync(AxisAlignedBB axisalignedbb, double toX, double toZ,
+    public final void loadChunksForMoveAsync(AxisAlignedBB axisalignedbb, int toX, int toZ, // Yatopia
                                              java.util.function.Consumer<List<IChunkAccess>> onLoad) {
         if (Thread.currentThread() != this.serverThread) {
             this.getChunkProvider().serverThreadQueue.execute(() -> {
@@ -296,6 +296,7 @@ public class WorldServer extends World implements GeneratorAccessSeed {
                 chunkProvider.getChunkAtAsynchronously(cx, cz, ChunkStatus.FULL, true, false, consumer);
             }
         }
+        chunkProvider.getChunkAtAsynchronously(toX >> 4, toZ >> 4, ChunkStatus.FULL, true, false, consumer); // Yatopia
     }
     // Tuinity end
 
diff --git a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
index eb0ce05d25ba33626d2dd3e3380d805c560bfe58..06d02d96af06ab28ab7cd30df620cb8495b36c1d 100644
--- a/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
+++ b/src/main/java/org/bukkit/craftbukkit/entity/CraftEntity.java
@@ -556,7 +556,7 @@ public abstract class CraftEntity implements org.bukkit.entity.Entity {
         net.minecraft.server.WorldServer world = ((CraftWorld)locationClone.getWorld()).getHandle();
         java.util.concurrent.CompletableFuture<Boolean> ret = new java.util.concurrent.CompletableFuture<>();
 
-        world.loadChunksForMoveAsync(getHandle().getBoundingBoxAt(locationClone.getX(), locationClone.getY(), locationClone.getZ()), location.getX(), location.getZ(), (list) -> {
+        world.loadChunksForMoveAsync(getHandle().getBoundingBoxAt(locationClone.getX(), locationClone.getY(), locationClone.getZ()), location.getBlockX(), location.getBlockZ(), (list) -> { // Yatopia
             net.minecraft.server.ChunkProviderServer chunkProviderServer = world.getChunkProvider();
             for (net.minecraft.server.IChunkAccess chunk : list) {
                 chunkProviderServer.addTicketAtLevel(net.minecraft.server.TicketType.POST_TELEPORT, chunk.getPos(), 33, CraftEntity.this.getEntityId());
